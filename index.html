<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ідеальний Продавець 2.0</title>
    <meta name="theme-color" content="#111827" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f3f4f6" media="(prefers-color-scheme: light)">
    <style>
        :root {
            --background: #f3f4f6;
            --foreground: #111827;
            --card: #ffffff;
            --muted: #6b7280;
            --border: #e5e7eb;
            --primary: #f97316;
            --primary-foreground: #0f172a;
            --accent: #111827;
            --shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04);
            --radius-lg: 1.25rem;
        }

        html.dark {
            --background: #111827;
            --foreground: #f9fafb;
            --card: #1f2937;
            --muted: #9ca3af;
            --border: #374151;
            --primary: #f59e0b;
            --primary-foreground: #111827;
            --accent: #f9fafb;
            --shadow: 0 15px 30px -10px rgb(249 250 251 / 0.15);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Inter", "SF Pro Display", "Segoe UI", system-ui, sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        @supports (padding: max(0px)) {
            body {
                padding-top: max(env(safe-area-inset-top), 0px);
                padding-bottom: max(env(safe-area-inset-bottom), 0px);
            }
        }

        html[data-platform="ios"] body {
            font-family: "SF Pro Text", "SF Pro Display", "Inter", system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        html[data-platform="android"] body {
            font-family: "Roboto", "Inter", "Segoe UI", system-ui, sans-serif;
        }

        html[data-platform="windows"] body {
            font-family: "Segoe UI", "Inter", system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        html[data-platform="mac"] body {
            font-family: "SF Pro Display", "Inter", system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .app-shell {
            max-width: 720px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--card);
            box-shadow: var(--shadow);
        }

        header {
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: blur(12px);
            background-color: color-mix(in srgb, var(--card) 90%, transparent);
            border-bottom: 1px solid var(--border);
        }

        .header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.875rem 1.25rem;
        }

        .header-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .icon-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 999px;
            border: 1px solid transparent;
            background: color-mix(in srgb, var(--primary) 12%, transparent);
            color: var(--foreground);
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .icon-button:hover {
            background: color-mix(in srgb, var(--primary) 18%, transparent);
            transform: translateY(-1px);
        }

        .icon-button:disabled {
            opacity: 0;
            pointer-events: none;
        }

        main {
            flex: 1;
            padding: 1.5rem 1.25rem 2.5rem;
        }

        .page {
            display: none;
            animation: fade-in 0.25s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1, h2, h3, h4 {
            margin: 0;
        }

        .welcome-card {
            text-align: center;
            margin-bottom: 1.75rem;
        }

        .welcome-card strong {
            display: block;
            font-size: 1.75rem;
            margin-bottom: 0.35rem;
        }

        .welcome-card span {
            color: var(--muted);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .menu-card {
            position: relative;
            padding: 1.25rem 1rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--card) 80%, var(--primary) 3%);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px -10px rgb(0 0 0 / 0.2);
        }

        .menu-icon {
            width: 52px;
            height: 52px;
            border-radius: 18px;
            background: color-mix(in srgb, var(--primary) 14%, transparent);
            display: grid;
            place-items: center;
            font-size: 1.35rem;
        }

        .section-title {
            font-size: 1.35rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .card {
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.25rem;
            background: color-mix(in srgb, var(--card) 90%, transparent);
            margin-bottom: 1rem;
        }

        details {
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            background: color-mix(in srgb, var(--card) 85%, transparent);
        }

        details + details {
            margin-top: 0.75rem;
        }

        summary {
            font-weight: 600;
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::after {
            content: "⌄";
            font-size: 1.1rem;
            transition: transform 0.2s ease;
        }

        details[open] summary::after {
            transform: rotate(180deg);
        }

        details ul,
        details ol {
            margin: 0.85rem 0 0;
            padding-left: 1.1rem;
            color: var(--muted);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            background: color-mix(in srgb, var(--primary) 14%, transparent);
            border-radius: 999px;
            padding: 0.3rem 0.8rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent);
        }

        .persona-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .persona-card {
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.1rem;
            background: color-mix(in srgb, var(--card) 90%, transparent);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .persona-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
        }

        .persona-card strong {
            font-size: 1.05rem;
        }

        .chat-shell {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .chat-header-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .chat-header span {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .chat-window {
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1rem;
            min-height: 320px;
            max-height: 480px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
            background: color-mix(in srgb, var(--card) 85%, transparent);
        }

        .message {
            max-width: 88%;
            padding: 0.75rem 0.95rem;
            border-radius: 1rem;
            font-size: 0.95rem;
            line-height: 1.45;
            position: relative;
        }

        .message.user {
            align-self: flex-end;
            background: var(--primary);
            color: var(--primary-foreground);
            border-bottom-right-radius: 0.5rem;
        }

        .message.assistant {
            align-self: flex-start;
            background: color-mix(in srgb, var(--primary) 12%, transparent);
            border-bottom-left-radius: 0.5rem;
        }

        .message.system {
            align-self: center;
            background: transparent;
            color: var(--muted);
            font-size: 0.85rem;
        }

        .typing {
            display: inline-flex;
            gap: 0.25rem;
        }

        .typing span {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: currentColor;
            opacity: 0.3;
            animation: typing 1s infinite;
        }

        .typing span:nth-child(2) {
            animation-delay: 0.15s;
        }

        .typing span:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes typing {
            0%, 100% { opacity: 0.25; transform: translateY(0); }
            50% { opacity: 0.8; transform: translateY(-2px); }
        }

        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .quick-replies button {
            border: 1px solid var(--border);
            border-radius: 999px;
            background: transparent;
            color: var(--muted);
            padding: 0.4rem 0.85rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: border-color 0.2s ease, transform 0.2s ease;
        }

        .quick-replies button:hover {
            border-color: var(--primary);
            color: var(--foreground);
            transform: translateY(-1px);
        }

        .composer {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 0.75rem;
            align-items: end;
        }

        .composer textarea {
            resize: none;
            min-height: 64px;
            max-height: 130px;
            border-radius: 0.9rem;
            border: 1px solid var(--border);
            padding: 0.75rem;
            background: color-mix(in srgb, var(--card) 90%, transparent);
            font-family: inherit;
            font-size: 0.95rem;
            color: inherit;
        }

        .composer textarea:focus {
            outline: 2px solid color-mix(in srgb, var(--primary) 30%, transparent);
            outline-offset: 2px;
        }

        .send-button {
            padding: 0.75rem 1.25rem;
            border-radius: 0.9rem;
            border: none;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary), color-mix(in srgb, var(--primary) 65%, #fb7185));
            color: var(--primary-foreground);
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .record-button {
            border-radius: 0.9rem;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--primary) 10%, transparent);
            color: var(--foreground);
            padding: 0.65rem 0.95rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            transition: border-color 0.2s ease, transform 0.2s ease, background 0.2s ease;
        }

        .record-button svg {
            width: 16px;
            height: 16px;
        }

        .record-button.is-recording {
            border-color: transparent;
            background: #dc2626;
            color: #ffffff;
            animation: pulse 1.2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.35); }
            50% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); }
        }

        .record-status {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .product-card {
            border: 1px solid var(--border);
            border-radius: 1rem;
            overflow: hidden;
            background: color-mix(in srgb, var(--card) 88%, transparent);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px -12px rgb(0 0 0 / 0.3);
        }

        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: color-mix(in srgb, var(--primary) 6%, transparent);
        }

        .product-card span {
            padding: 0.85rem;
            font-size: 0.95rem;
        }

        .products-info {
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 0.75rem;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            z-index: 50;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            position: relative;
            max-width: min(92vw, 640px);
            max-height: 90vh;
        }

        .modal-content img {
            width: 100%;
            height: auto;
            max-height: 90vh;
            border-radius: 1rem;
            box-shadow: 0 25px 30px -10px rgb(0 0 0 / 0.45);
        }

        .modal-close {
            position: absolute;
            top: 0.85rem;
            right: 0.85rem;
            width: 42px;
            height: 42px;
            border-radius: 999px;
            border: none;
            background: rgba(15, 23, 42, 0.85);
            color: #ffffff;
            cursor: pointer;
            font-size: 1.25rem;
        }

        .contact-list {
            display: grid;
            gap: 0.75rem;
        }

        .contact-card {
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1rem;
            background: color-mix(in srgb, var(--card) 92%, transparent);
        }

        .contact-card strong {
            display: block;
            margin-bottom: 0.25rem;
        }

        .knowledge-list li + li,
        .checklist li + li {
            margin-top: 0.35rem;
        }

        .quiz-placeholder {
            border: 1px dashed var(--border);
            border-radius: 1rem;
            padding: 1.25rem;
            display: grid;
            gap: 0.75rem;
            text-align: center;
            background: color-mix(in srgb, var(--card) 80%, transparent);
        }

        .subtle-link {
            color: var(--primary);
            text-decoration: none;
        }

        .subtle-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 640px) {
            main {
                padding: 1.25rem 1rem 2.5rem;
            }

            .menu-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .chat-window {
                min-height: 280px;
                max-height: 420px;
            }

            .persona-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <header>
            <div class="header-inner">
                <div class="header-group">
                    <button id="backButton" class="icon-button" aria-label="Назад" disabled>←</button>
                    <div>
                        <h1 id="headerTitle" style="font-size: 1.1rem; font-weight: 700;">Ідеальний Продавець 2.0</h1>
                        <span id="headerSubtitle" style="font-size: 0.85rem; color: var(--muted);">Все для успішної зміни</span>
                    </div>
                </div>
                <div class="header-group">
                    <button id="refreshButton" class="icon-button" aria-label="Оновити" title="Оновити дані">⟳</button>
                    <button id="themeToggle" class="icon-button" aria-label="Змінити тему">☀️</button>
                </div>
            </div>
        </header>

        <main id="appMain">
            <section id="home" class="page active" aria-labelledby="headerTitle">
                <div class="welcome-card">
                    <strong id="welcomeHeadline">Вітаємо, колего!</strong>
                    <span>Обирайте інструмент і вирушайте в зміну з посмішкою.</span>
                </div>
                <div class="menu-grid" role="menu">
                    <article class="menu-card" data-target="assistant">
                        <div class="menu-icon">🤖</div>
                        <div>
                            <h3 style="margin-bottom: 0.25rem;">ШІ-помічник</h3>
                            <p style="color: var(--muted); font-size: 0.85rem;">Миттєві відповіді на робочі запитання.</p>
                        </div>
                    </article>
                    <article class="menu-card" data-target="knowledge">
                        <div class="menu-icon">📚</div>
                        <div>
                            <h3 style="margin-bottom: 0.25rem;">База Знань</h3>
                            <p style="color: var(--muted); font-size: 0.85rem;">Покрокові інструкції та скрипти.</p>
                        </div>
                    </article>
                    <article class="menu-card" data-target="checklists">
                        <div class="menu-icon">✅</div>
                        <div>
                            <h3 style="margin-bottom: 0.25rem;">Чек-листи</h3>
                            <p style="color: var(--muted); font-size: 0.85rem;">Контроль щоденних рутин.</p>
                        </div>
                    </article>
                    <article class="menu-card" data-target="products">
                        <div class="menu-icon">🛒</div>
                        <div>
                            <h3 style="margin-bottom: 0.25rem;">Наша Продукція</h3>
                            <p style="color: var(--muted); font-size: 0.85rem;">Каталог «Галя Балувана».</p>
                        </div>
                    </article>
                    <article class="menu-card" data-target="quiz">
                        <div class="menu-icon">🎯</div>
                        <div>
                            <h3 style="margin-bottom: 0.25rem;">Перевірка Знань</h3>
                            <p style="color: var(--muted); font-size: 0.85rem;">Тести та тренажери.</p>
                        </div>
                    </article>
                    <article class="menu-card" data-target="contacts">
                        <div class="menu-icon">📞</div>
                        <div>
                            <h3 style="margin-bottom: 0.25rem;">Корисні Контакти</h3>
                            <p style="color: var(--muted); font-size: 0.85rem;">Зв'язок з наставниками.</p>
                        </div>
                    </article>
                </div>
            </section>

            <section id="assistant" class="page" aria-live="polite">
                <h2 class="section-title">ШІ-помічник</h2>
                <div id="personaSelection">
                    <p style="color: var(--muted); margin-bottom: 1.25rem;">Оберіть «особистість» помічника, щоб отримати релевантні відповіді.</p>
                    <div class="persona-grid">
                        <article class="persona-card" data-persona="seller">
                            <span class="badge">🔸 Рекомендовано</span>
                            <strong>ШІ-продавець</strong>
                            <p style="color: var(--muted); font-size: 0.9rem;">Рішення для каси, повернень, сервісу та роботи з клієнтами.</p>
                        </article>
                        <article class="persona-card" data-persona="cosmetologist">
                            <strong>ШІ-косметолог</strong>
                            <p style="color: var(--muted); font-size: 0.9rem;">Поради з догляду та консультації щодо асортименту косметики.</p>
                        </article>
                        <article class="persona-card" data-persona="study">
                            <strong>Помічник з уроками</strong>
                            <p style="color: var(--muted); font-size: 0.9rem;">Пояснить навчальні матеріали, допоможе закріпити знання.</p>
                        </article>
                        <article class="persona-card" data-persona="chitchat">
                            <strong>Просто потеревенькати</strong>
                            <p style="color: var(--muted); font-size: 0.9rem;">Підтримка настрою та неформальні розмови під час перерви.</p>
                        </article>
                    </div>
                </div>

                <div id="chatArea" class="chat-shell" hidden>
                    <div class="chat-header">
                        <div class="chat-header-info">
                            <strong id="personaTitle">ШІ-продавець</strong>
                            <span id="personaSubtitle">Ваш цифровий наставник</span>
                        </div>
                        <button id="changePersona" class="record-button" type="button">Змінити персону</button>
                    </div>

                    <div id="quickReplies" class="quick-replies" hidden></div>

                    <div id="chatWindow" class="chat-window" role="log" aria-live="polite"></div>

                    <div>
                        <div id="recordStatus" class="record-status"></div>
                        <div class="composer">
                            <button id="recordButton" class="record-button" type="button">
                                <span aria-hidden="true">●</span>
                                <span>Голос</span>
                            </button>
                            <textarea id="messageInput" placeholder="Напишіть повідомлення..." rows="2"></textarea>
                            <button id="sendButton" class="send-button" type="button">Надіслати</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="knowledge" class="page">
                <h2 class="section-title">База знань «Галя Балувана»</h2>
                <p style="color: var(--muted); margin-bottom: 1rem;">Скористайтесь інструкціями, щоб впевнено почуватися на зміні.</p>
                <div id="knowledgeList"></div>
            </section>

            <section id="checklists" class="page">
                <h2 class="section-title">Чек-листи зміни</h2>
                <div class="card">
                    <h3 style="margin-bottom: 0.5rem;">Ранковий старт</h3>
                    <ol class="checklist" style="color: var(--muted);">
                        <li>Перевірте графік доставки й наявність ключових товарів.</li>
                        <li>Увімкніть обладнання: касу Poster, термінал, холодильники.</li>
                        <li>Проведіть санітарний чек: руки, форма, чистота вітрини.</li>
                        <li>Оновіть викладку за принципом <strong>FIFO</strong> та фейсингом.</li>
                        <li>Привітайте перших гостей та уточніть їх потреби.</li>
                    </ol>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 0.5rem;">Під час зміни</h3>
                    <ol class="checklist" style="color: var(--muted);">
                        <li>Ведіть продажі в Poster, додавайте коментарі до складних чеків.</li>
                        <li>Контролюйте температуру холодильних зон (≤5°C) та гарячих страв (≥63°C).</li>
                        <li>Фіксуйте службові внесення/видачі з коротким описом.</li>
                        <li>Пропонуйте додаткові продукти згідно сервіс-скриптів.</li>
                        <li>Ведіть журнал скарг/побажань для менеджера.</li>
                    </ol>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 0.5rem;">Завершення зміни</h3>
                    <ol class="checklist" style="color: var(--muted);">
                        <li>Проведіть звірку готівки та сформуйте <strong>Z-звіт</strong> у ПРРО.</li>
                        <li>Перевірте чистоту та закрийте вітрини, вимкніть обладнання.</li>
                        <li>Поповніть розмін за потреби, підготуйте звіт для менеджера.</li>
                        <li>Оформіть передачу зміни та зафіксуйте показники продажів.</li>
                    </ol>
                </div>
            </section>

            <section id="products" class="page">
                <h2 class="section-title">Наша продукція</h2>
                <p class="products-info">Каталог оновлюється автоматично. Оберіть картку, щоб переглянути зображення у повному розмірі.</p>
                <div id="productsState" class="products-info"></div>
                <div id="productGrid" class="product-grid" aria-live="polite"></div>
            </section>

            <section id="quiz" class="page">
                <h2 class="section-title">Перевірка знань</h2>
                <div class="quiz-placeholder">
                    <p>Ітерація 1: ми збираємо дані про ваш прогрес у чаті та чек-листах. У наступному оновленні з'являться персональні тести з автоматичним нарахуванням балів.</p>
                    <p style="color: var(--muted);">Поки що радимо пройти коротке самотестування з наставником.</p>
                </div>
            </section>

            <section id="contacts" class="page">
                <h2 class="section-title">Корисні контакти</h2>
                <div class="contact-list">
                    <article class="contact-card">
                        <strong>Менеджер магазину</strong>
                        <div style="color: var(--muted);">Марія Коваль • +38 (067) 000-00-01</div>
                        <div style="color: var(--muted);">Питання змін, графік, побажання клієнтів.</div>
                    </article>
                    <article class="contact-card">
                        <strong>HR-наставник</strong>
                        <div style="color: var(--muted);">Ігор Савчук • +38 (050) 000-00-02</div>
                        <div style="color: var(--muted);">Онбординг, навчання, документи.</div>
                    </article>
                    <article class="contact-card">
                        <strong>Лінія підтримки Poster</strong>
                        <div style="color: var(--muted);">support@joinposter.com</div>
                        <a class="subtle-link" href="https://knowledge-base.joinposter.com/uk-ua" target="_blank" rel="noopener">База знань Poster →</a>
                    </article>
                </div>
            </section>
        </main>
    </div>

    <div id="imageModal" class="modal" role="dialog" aria-modal="true" aria-label="Перегляд зображення">
        <div class="modal-content">
            <button id="modalClose" class="modal-close" aria-label="Закрити">×</button>
            <img id="modalImage" src="" alt="Зображення продукту">
        </div>
    </div>

    <script>
        (function () {
            const WEBHOOK_URL = "https://example.com/gb-assistant";
            const tg = window.Telegram ? window.Telegram.WebApp : undefined;

            function detectPlatform() {
                const ua = navigator.userAgent || '';
                const platform = navigator.userAgentData?.platform || navigator.platform || '';
                if (/iPad|iPhone|iPod/.test(ua)) return 'ios';
                if (/Android/.test(ua)) return 'android';
                if (/Mac/.test(platform)) return 'mac';
                if (/Win/.test(platform)) return 'windows';
                return 'other';
            }

            document.documentElement.dataset.platform = detectPlatform();
            if (tg) {
                try {
                    tg.ready();
                    tg.expand();
                } catch (error) {
                    console.warn("Telegram WebApp init failed", error);
                }
            }

            const initData = tg?.initData || "";
            const userData = tg?.initDataUnsafe?.user || {};

            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const themeToggle = document.getElementById('themeToggle');

            function persistTheme(theme) {
                try {
                    localStorage.setItem('ideal-seller-theme', theme);
                } catch (error) {
                    console.warn('Cannot persist theme preference', error);
                }
            }

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    themeToggle?.textContent = '🌙';
                } else {
                    document.documentElement.classList.remove('dark');
                    themeToggle?.textContent = '☀️';
                }
                persistTheme(theme);
            }

            let savedTheme = null;
            try {
                savedTheme = localStorage.getItem('ideal-seller-theme');
            } catch (error) {
                console.warn('Cannot read saved theme', error);
            }
            if (tg?.colorScheme === 'dark' || savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }

            themeToggle?.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                applyTheme(isDark ? 'dark' : 'light');
            });

            const firstName = userData?.first_name ? userData.first_name : 'колего';
            const welcomeHeadline = document.getElementById('welcomeHeadline');
            welcomeHeadline.textContent = `Вітаємо, ${firstName}!`;

            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');
            const backButton = document.getElementById('backButton');
            const refreshButton = document.getElementById('refreshButton');
            const pages = document.querySelectorAll('.page');
            const menuCards = document.querySelectorAll('.menu-card');
            const appMain = document.getElementById('appMain');
            let currentPage = 'home';

            function focusFirstInteractive(pageId) {
                window.requestAnimationFrame(() => {
                    const page = document.getElementById(pageId);
                    if (!page) return;
                    const focusable = page.querySelector('button, a, textarea, input');
                    focusable?.focus({ preventScroll: true });
                });
            }

            function setPage(pageId) {
                pages.forEach((page) => {
                    page.classList.toggle('active', page.id === pageId);
                });
                currentPage = pageId;
                const isHome = pageId === 'home';
                backButton.disabled = isHome;
                const activePage = document.getElementById(pageId);
                const pageHeading = activePage?.querySelector('h2, h3');
                headerTitle.textContent = isHome ? 'Ідеальний Продавець 2.0' : pageHeading?.textContent || 'Ідеальний Продавець 2.0';
                headerSubtitle.textContent = isHome ? 'Все для успішної зміни' : 'Поверніться, щоб обрати інший розділ';
                focusFirstInteractive(pageId);
            }

            backButton.addEventListener('click', () => {
                if (currentPage !== 'home') {
                    setPage('home');
                }
            });

            menuCards.forEach((card) => {
                card.addEventListener('click', () => {
                    const target = card.getAttribute('data-target');
                    if (!target) return;
                    setPage(target);
                    if (target === 'products') {
                        fetchProducts();
                    }
                });
            });

            refreshButton.addEventListener('click', () => {
                if (currentPage === 'products') {
                    fetchProducts(true);
                } else if (currentPage === 'assistant' && selectedPersona) {
                    sendSystemMessage('Очистили чат. Оберіть нову тему або напишіть повідомлення.');
                    chatWindow.innerHTML = '';
                }
            });

            const knowledgeContent = [
                {
                    title: 'Робота зі зміною в Poster',
                    items: [
                        'Кожен продавець має персональний логін, пароль і ПІН. Не передавайте їх колегам.',
                        'Вхід: [заклад].joinposter.com → логін/пароль → ПІН. Переконайтесь, що касовий день відкритий.',
                        'Додавання товару: пошук, категорії або сканер штрихкоду. Контролюйте правильність ціни і знижок.',
                        'Оплата: приймайте готівку, картки, сертифікати. Для змішаної оплати використовуйте split-payment.',
                        'X-звіт дозволяє перевірити готівку протягом дня, Z-звіт закриває зміну і відправляє дані до ДПС.'
                    ]
                },
                {
                    title: 'ПРРО 2.0: фіскалізація без паніки',
                    items: [
                        'ПРРО автоматично передає чеки в податкову. Якщо немає зв'язку, система працює офлайн до 36 годин.',
                        'Електронний чек можна показати клієнту у вигляді QR-коду або відправити на email/SMS.',
                        'Для повернення оформіть коригуючий чек. Обовʼязково поясніть причину та зафіксуйте контакт клієнта.',
                        'Після закриття зміни сформуйте Z-звіт у ПРРО та переконайтесь, що він успішно відправлений.'
                    ]
                },
                {
                    title: 'Стандарти сервісу',
                    items: [
                        'Привітання: «Доброго дня! Вітаємо у “Галя Балувана”. Чим можу допомогти?»',
                        'Уточнення потреби: ставте відкриті запитання і пропонуйте рішення, а не лише товар.',
                        'Ап- та крос-сел: «До вареників радимо наш сметанковий соус. Спробуєте?»',
                        'Робота зі скаргою: слухайте, емпатично реагуйте, запропонуйте рішення і зафіксуйте кейс.'
                    ]
                },
                {
                    title: 'Алгоритми для складних ситуацій',
                    items: [
                        'Повернення без чеку: приймаємо, якщо є електронний чек/банківська виписка/відео. Фіксуємо акт повернення.',
                        'Агресивний клієнт: техніка LEARN — Listen, Empathize, Ask, Resolve, Next Step. Залучіть менеджера, якщо потрібно.',
                        'Конфлікт між колегами: зафіксуйте ситуацію, забезпечте спокій для гостей, повідомте менеджера.',
                        'Підозра на крадіжку: дотримуйтесь процедур безпеки, не звинувачуйте напряму, викличте охорону або менеджера.'
                    ]
                },
                {
                    title: 'Мерчандайзинг та FIFO',
                    items: [
                        'Ротація товару: нові партії ставимо вглиб полиці, старіші — на фасад.',
                        'Контроль термінів придатності щозміни. Позначайте товари, що потребують розпродажу.',
                        'Фейсинг: вирівнюйте упаковки, додавайте POS-матеріали, перевіряйте цінники.',
                        'Чистота: вітрини, холодильники і касова зона протираються щонайменше 3 рази на день.'
                    ]
                }
            ];

            const knowledgeList = document.getElementById('knowledgeList');
            knowledgeContent.forEach((section) => {
                const details = document.createElement('details');
                const summary = document.createElement('summary');
                summary.textContent = section.title;
                details.appendChild(summary);

                const list = document.createElement('ul');
                list.classList.add('knowledge-list');
                section.items.forEach((item) => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    list.appendChild(li);
                });
                details.appendChild(list);
                knowledgeList.appendChild(details);
            });

            const personaSelection = document.getElementById('personaSelection');
            const chatArea = document.getElementById('chatArea');
            const personaCards = personaSelection.querySelectorAll('.persona-card');
            const personaTitle = document.getElementById('personaTitle');
            const personaSubtitle = document.getElementById('personaSubtitle');
            const chatWindow = document.getElementById('chatWindow');
            const quickReplies = document.getElementById('quickReplies');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const recordButton = document.getElementById('recordButton');
            const changePersona = document.getElementById('changePersona');
            const recordStatus = document.getElementById('recordStatus');

            const personas = {
                seller: {
                    id: 'seller',
                    title: 'ШІ-продавець',
                    subtitle: 'Ваш експерт з роботи в магазині',
                    greeting: 'Вітаю! Я допоможу з касою, сервісом і складними клієнтами. Що підказати?',
                    quickReplies: [
                        'Повернення без чеку',
                        'Агресивний клієнт',
                        'Як оформити Z-звіт?',
                        'Що робити з простроченим товаром?'
                    ]
                },
                cosmetologist: {
                    id: 'cosmetologist',
                    title: 'ШІ-косметолог',
                    subtitle: 'Рекомендації з догляду та краси',
                    greeting: 'Привіт! Порадити крем чи підібрати рутину догляду? Пишіть, допоможу.',
                    quickReplies: []
                },
                study: {
                    id: 'study',
                    title: 'Помічник з уроками',
                    subtitle: 'Пояснює навчальні матеріали',
                    greeting: 'Ходімо розберемося з навчальними модулями. Про що поговоримо спочатку?',
                    quickReplies: []
                },
                chitchat: {
                    id: 'chitchat',
                    title: 'Співрозмовник',
                    subtitle: 'Легка розмова для перепочинку',
                    greeting: 'Як проходить зміна? Можу підтримати бесіду або підняти настрій!',
                    quickReplies: []
                }
            };

            let selectedPersona = null;
            let isSending = false;
            let mediaRecorder = null;
            let recordChunks = [];
            let isRecording = false;

            function appendMessage(role, content, options = {}) {
                const bubble = document.createElement('div');
                bubble.classList.add('message', role);
                if (options.typing) {
                    bubble.innerHTML = '<div class="typing" aria-hidden="true"><span></span><span></span><span></span></div>';
                } else {
                    bubble.innerHTML = content.replace(/\n/g, '<br>');
                }
                chatWindow.appendChild(bubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return bubble;
            }

            function sendSystemMessage(text) {
                appendMessage('system', text);
            }

            function startChat(persona) {
                selectedPersona = persona;
                personaSelection.hidden = true;
                chatArea.hidden = false;
                chatWindow.innerHTML = '';
                personaTitle.textContent = persona.title;
                personaSubtitle.textContent = persona.subtitle;
                if (persona.quickReplies.length) {
                    quickReplies.innerHTML = '';
                    persona.quickReplies.forEach((item) => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.textContent = item;
                        button.addEventListener('click', () => {
                            messageInput.value = item;
                            messageInput.focus();
                        });
                        quickReplies.appendChild(button);
                    });
                    quickReplies.hidden = false;
                } else {
                    quickReplies.hidden = true;
                    quickReplies.innerHTML = '';
                }
                appendMessage('assistant', persona.greeting);
            }

            personaCards.forEach((card) => {
                card.addEventListener('click', () => {
                    const personaKey = card.getAttribute('data-persona');
                    if (!personaKey) return;
                    const persona = personas[personaKey];
                    if (!persona) return;
                    startChat(persona);
                });
            });

            changePersona.addEventListener('click', () => {
                selectedPersona = null;
                chatArea.hidden = true;
                personaSelection.hidden = false;
                chatWindow.innerHTML = '';
            });

            async function blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64data = reader.result?.split(',')[1];
                        if (!base64data) {
                            reject(new Error('Не вдалося кодувати аудіо'));
                        } else {
                            resolve(base64data);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            async function sendMessageToServer(payload) {
                try {
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    const data = await response.json();
                    if (Array.isArray(data) && data[0]?.output) {
                        return data[0].output;
                    }
                    if (data?.output) {
                        return data.output;
                    }
                    return 'Отримано відповідь, але її не вдалося розпізнати.';
                } catch (error) {
                    console.error('Помилка запиту', error);
                    return 'Не вдалося отримати відповідь. Перевірте зʼєднання або спробуйте ще раз.';
                }
            }

            async function handleSend({ text, audioBase64 }) {
                if (!selectedPersona || isSending) {
                    return;
                }

                const payload = {
                    persona: selectedPersona.id,
                    initData,
                    timestamp: new Date().toISOString()
                };

                if (text) {
                    payload.text = text;
                }
                if (audioBase64) {
                    payload.audio = audioBase64;
                }

                isSending = true;
                sendButton.disabled = true;
                recordButton.disabled = true;

                const typingBubble = appendMessage('assistant', '', { typing: true });
                const reply = await sendMessageToServer(payload);
                typingBubble.remove();
                appendMessage('assistant', reply || 'Вибачте, я не зрозумів запит. Спробуйте переформулювати.');

                isSending = false;
                sendButton.disabled = false;
                recordButton.disabled = false;
            }

            sendButton.addEventListener('click', async () => {
                const text = messageInput.value.trim();
                if (!text || !selectedPersona) {
                    return;
                }
                appendMessage('user', text);
                messageInput.value = '';
                await handleSend({ text });
            });

            messageInput.addEventListener('keydown', async (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendButton.click();
                }
            });

            async function stopRecording() {
                if (!mediaRecorder) return;
                mediaRecorder.stop();
            }

            recordButton.addEventListener('click', async () => {
                if (!selectedPersona) {
                    sendSystemMessage('Спершу оберіть персону, щоб розпочати спілкування.');
                    return;
                }
                if (isRecording) {
                    stopRecording();
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    recordChunks = [];
                    mediaRecorder.addEventListener('dataavailable', (event) => {
                        if (event.data.size > 0) {
                            recordChunks.push(event.data);
                        }
                    });
                    mediaRecorder.addEventListener('stop', async () => {
                        stream.getTracks().forEach((track) => track.stop());
                        isRecording = false;
                        recordButton.classList.remove('is-recording');
                        recordStatus.textContent = '';
                        recordButton.disabled = false;
                        if (!recordChunks.length) {
                            return;
                        }
                        const blob = new Blob(recordChunks, { type: 'audio/webm' });
                        try {
                            const base64 = await blobToBase64(blob);
                            appendMessage('user', '🎙️ Голосове повідомлення');
                            await handleSend({ audioBase64: base64 });
                        } catch (error) {
                            console.error('Помилка обробки аудіо', error);
                            sendSystemMessage('Не вдалося обробити голосове повідомлення. Спробуйте ще раз.');
                        }
                    });
                    mediaRecorder.start();
                    isRecording = true;
                    recordButton.classList.add('is-recording');
                    recordButton.disabled = false;
                    recordStatus.textContent = 'Записуємо... Натисніть ще раз, щоб завершити.';
                } catch (error) {
                    console.error('Помилка доступу до мікрофона', error);
                    recordStatus.textContent = 'Немає доступу до мікрофона. Дозвольте запис у налаштуваннях.';
                }
            });

            // PRODUCTS
            const productGrid = document.getElementById('productGrid');
            const productsState = document.getElementById('productsState');
            let productsLoaded = false;

            async function fetchProducts(force) {
                if (productsLoaded && !force) {
                    return;
                }
                productsState.textContent = 'Завантажуємо каталог...';
                productGrid.innerHTML = '';
                try {
                    const response = await fetch('catalog.json', { cache: force ? 'reload' : 'default' });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    const products = await response.json();
                    if (!Array.isArray(products) || !products.length) {
                        productsState.textContent = 'Каталог поки порожній. Спробуйте пізніше.';
                        return;
                    }
                    productsState.textContent = `Доступно позицій: ${products.length}`;
                    productGrid.innerHTML = '';
                    const fragment = document.createDocumentFragment();
                    products.forEach((product) => {
                        const card = document.createElement('article');
                        card.classList.add('product-card');
                        const img = document.createElement('img');
                        img.alt = product.name || 'Продукт';
                        img.loading = 'lazy';
                        img.decoding = 'async';
                        if (product.thumbnail) {
                            img.src = product.thumbnail;
                        } else if (product.image) {
                            img.src = product.image;
                        }
                        card.appendChild(img);
                        const title = document.createElement('span');
                        title.textContent = product.name || 'Без назви';
                        card.appendChild(title);
                        card.addEventListener('click', () => {
                            openModal(product.image || product.thumbnail, product.name);
                        });
                        fragment.appendChild(card);
                    });
                    productGrid.appendChild(fragment);
                    productsLoaded = true;
                } catch (error) {
                    console.error('Помилка каталогу', error);
                    productsState.textContent = 'Не вдалося завантажити каталог. Перевірте зʼєднання або натисніть ⟳.';
                }
            }

            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalClose = document.getElementById('modalClose');

            function openModal(src, alt) {
                if (!src) return;
                modalImage.src = src;
                modalImage.alt = alt || 'Зображення продукту';
                imageModal.classList.add('active');
            }

            function closeModal() {
                imageModal.classList.remove('active');
                modalImage.src = '';
            }

            modalClose.addEventListener('click', closeModal);
            imageModal.addEventListener('click', (event) => {
                if (event.target === imageModal) {
                    closeModal();
                }
            });
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });

            // initial knowledge open first
            const firstDetails = knowledgeList.querySelector('details');
            if (firstDetails) {
                firstDetails.setAttribute('open', '');
            }
        })();
    </script>
</body>
</html>
